---
name: CI
on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - master

env:
  FLUTTER_VERSION: 3.16.4

jobs:
  integration-ios:
    name: Integration Testing - iOS
    runs-on: macos-13
    steps:
      - name: "List all simulators"
        run: "xcrun xctrace list devices"

      - name: "Start Simulator"
        env:
          DEVICE: ${{ vars.IOS_SIMULATOR }}
        run: |
          UDID=$(xcrun xctrace list devices | grep "^$DEVICE (" | awk '{gsub(/[()]/,""); print $NF}')
          echo $UDID
          xcrun simctl boot "${UDID:?No Simulator with this name found}"

      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      - name: Cache build files
        uses: irgaly/xcode-cache@v1
        with:
          key: build-pubspec-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            build-pubspec-${{ runner.os }}
      - name: Install Flutter dependencies
        run: flutter pub get
      - name: Run integration tests
        run: |
          flutter drive --driver=test_driver/integration_test.dart --target=integration_test/main.dart 
